<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kubuki Robot Security Control Center (Remote)</title>
  <link rel="stylesheet" href="css/cams.css"/>
  <link rel="stylesheet" href="css/stats.css"/>
  <style>
    .active-btn {
        background: #4caf50 !important;
        color: white !important;
        transform: scale(0.95);
    }
  </style>
</head>
<body>

<header style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: linear-gradient(90deg, #0f3d91, #0d63c3); box-shadow: 0 2px 10px rgba(0,0,0,0.5); color: #fff;">
  <h1 style="margin: 0; font-size: 1.5rem;">Kubuki Robot Security Control Center</h1>
</header>

<main>
  <!-- Camera Feed -->
  <div class="cam-box">
      <h3>Front Cam</h3>
      <img src="http://100.73.66.119:9081" alt="Front Camera Feed" />
  </div>

  <!-- Kobuki Control Buttons -->
  <div class="controls kobuki-controls">
      <h2>Kobuki Control</h2>
      <button id="btn-up" onclick="sendCmd('w')">Forward ⬆</button>
      <button id="btn-down" onclick="sendCmd('s')">Backward ⬇</button>
      <button id="btn-left" onclick="sendCmd('a')">Left ⬅</button>
      <button id="btn-right" onclick="sendCmd('d')">Right ➡</button>
      <button id="btn-stop" onclick="sendCmd('x')">Stop ⏹</button>
  </div>
</main>


<script>
// Replace with your Pi's IP
const PI_IP = "100.73.66.119";

function sendCmd(cmd){
    fetch(`http://${PI_IP}/cmd_receiver.php?cmd=${cmd}`)
        .then(res => res.text())
        .then(data => console.log("Sent:", cmd, "Response:", data))
        .catch(err => console.error("Error sending command:", err));
}

// Toggle stats container
function toggleStats() {
    const stats = document.querySelector('.stats-content');
    const btn = document.querySelector('.toggle-stats');
    stats.classList.toggle('show');
    btn.classList.toggle('open');
}

// ------------------- Gamepad Controller -------------------
let lastPress = {};

// D-pad + X + shoulder & triggers
const buttonMap = {
    12: { cmd: "w", id: "btn-up" },     // Dpad Up
    13: { cmd: "s", id: "btn-down" },   // Dpad Down
    14: { cmd: "a", id: "btn-left" },   // Dpad Left
    15: { cmd: "d", id: "btn-right" },  // Dpad Right
    0:  { cmd: "x", id: "btn-stop" },   // X Button
    4:  { cmd: "a", id: "btn-left" },   // L1 = Left
    5:  { cmd: "d", id: "btn-right" },  // R1 = Right
    6:  { cmd: "s", id: "btn-down" },   // L2 = Backward
    7:  { cmd: "w", id: "btn-up" }      // R2 = Forward
};

function gamepadLoop() {
    const gp = navigator.getGamepads()[0];
    if (gp) {
        for (const index in buttonMap) {
            const { cmd, id } = buttonMap[index];
            const btn = gp.buttons[index];
            const element = document.getElementById(id);

            if (!btn) continue;

            if (btn.pressed) {
                element.classList.add("active-btn");
                if (!lastPress[index]) {
                    lastPress[index] = true;
                    sendCmd(cmd);
                }
            } else {
                element.classList.remove("active-btn");
                lastPress[index] = false;
            }
        }
    }
    requestAnimationFrame(gamepadLoop);
}

// Auto start gamepad detection
window.addEventListener("load", () => {
    console.log("Controller loop started. Plug in USB or connect Bluetooth controller.");
    requestAnimationFrame(gamepadLoop);
});

// Optional: Log controller connect/disconnect
window.addEventListener("gamepadconnected", (e) => {
    console.log("Controller connected:", e.gamepad.id);
});
window.addEventListener("gamepaddisconnected", (e) => {
    console.log("Controller disconnected:", e.gamepad.id);
});
</script>

<script src="js/cams.js"></script>

</body>
</html>
